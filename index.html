<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ –∫–∞–º–ø–∞–Ω–∏–π SS25</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="min-h-screen p-6 flex items-center justify-center">
            <div class="max-w-2xl mx-auto text-center">
                <h1 class="text-3xl font-bold text-gray-900 mb-8">ATL Mediascope —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
                
                <div class="bg-white rounded-lg shadow p-8">
                    <div class="mb-6">
                        <svg class="mx-auto h-16 w-16 text-blue-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                    </div>
                    
                    <h2 class="text-xl font-semibold mb-4">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</h2>
                    <p class="text-gray-600 mb-6" id="statusText">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</p>
                    
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                    </div>

                    <div id="errorMessage" class="hidden mt-6 p-4 bg-red-50 text-red-700 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_DATA_URL = 'https://raw.githubusercontent.com/Opiumofthepeople/Mediascope/main/Mediascope_Reach_24_10_normalized_final_guthub.xlsx';

        let appData = null;
        let selectedCampaigns = [];
        let activeTab = '–ì–æ—Ä–æ–¥–∞';

window.addEventListener('DOMContentLoaded', function() {
    loadFromGitHub();
});

async function loadFromGitHub() {
    const statusText = document.getElementById('statusText');
    
    try {
        const response = await fetch(GITHUB_DATA_URL);
        
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status} ${response.statusText}`);
        }
        
        statusText.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
        const arrayBuffer = await response.arrayBuffer();
        processExcelData(arrayBuffer);
        
    } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ GitHub:\n\n' + error.message + 
                  '\n\n–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n‚Ä¢ –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏\n‚Ä¢ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É\n‚Ä¢ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞');
    }
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    
    document.getElementById('statusText').textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
}

function processExcelData(arrayBuffer) {
    try {
        const workbook = XLSX.read(arrayBuffer);
        const sheets = {};
        
        for (const sheetName of workbook.SheetNames) {
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: null });
            
            if (jsonData.length > 0) {
                const headers = jsonData[0];
                const rows = jsonData.slice(1).filter(row => row.some(cell => cell !== null && cell !== ''));
                
                sheets[sheetName] = {
                    headers: headers,
                    data: rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index];
                        });
                        return obj;
                    })
                };
            }
        }
        
        appData = sheets;
        selectedCampaigns = [];
        renderDashboard();
    } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: ' + error.message);
    }
}

function formatNumber(num, type) {
    if (num === null || num === undefined || num === '' || num === '-') return '‚Äî';
    
    const value = typeof num === 'string' ? parseFloat(num) : num;
    if (isNaN(value)) return '‚Äî';

    if (type === 'percent') {
        return (value * 100).toLocaleString('ru-RU', { minimumFractionDigits: 1, maximumFractionDigits: 2 }) + '%';
    } else if (type === 'percent_int') {
        return (value * 100).toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + '%';
    } else if (type === 'percent4') {
        return (value * 100).toLocaleString('ru-RU', { minimumFractionDigits: 4, maximumFractionDigits: 4 }) + '%';
    } else if (type === 'currency') {
        return value.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    } else if (type === 'cpm') {
        return value.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ‚ÇΩ';
    } else if (type === 'cptu') {
        return value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚ÇΩ';
    } else if (type === 'frequency') {
        return value.toLocaleString('ru-RU', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    } else if (type === 'integer') {
        return value.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    } else {
        return value.toLocaleString('ru-RU');
    }
}

function getConditionalColor(value, allValues, reverse = false) {
    if (value === null || value === undefined || value === '' || value === '‚Äî') return '';
    
    const numValue = typeof value === 'string' ? parseFloat(value) : value;
    if (isNaN(numValue)) return '';
    
    const validValues = allValues
        .map(v => typeof v === 'string' ? parseFloat(v) : v)
        .filter(v => !isNaN(v) && v !== null && v !== undefined);
    
    if (validValues.length === 0) return '';
    
    const min = Math.min(...validValues);
    const max = Math.max(...validValues);
    
    if (min === max) return 'background-color: rgb(255, 250, 205);';
    
    let normalized = (numValue - min) / (max - min);
    
    if (reverse) {
        normalized = 1 - normalized;
    }
    
    const yellowR = 255, yellowG = 250, yellowB = 205;
    const greenR = 144, greenG = 238, greenB = 144;
    
    const r = Math.round(yellowR + (greenR - yellowR) * normalized);
    const g = Math.round(yellowG + (greenG - yellowG) * normalized);
    const b = Math.round(yellowB + (greenB - yellowB) * normalized);
    
    return `background-color: rgb(${r}, ${g}, ${b});`;
}

function campaignMatches(rowCampaign, selectedCampaign) {
    if (!rowCampaign || !selectedCampaign) return false;
    
    if (rowCampaign === selectedCampaign) return true;
    
    const normalize = (str) => str.toLowerCase().trim()
        .replace(/[""]/g, '"')
        .replace(/\s+/g, ' ');
    
    const normalizedRow = normalize(rowCampaign);
    const normalizedSelected = normalize(selectedCampaign);
    
    if (normalizedRow === normalizedSelected) return true;
    
    if (normalizedRow.includes(normalizedSelected) || normalizedSelected.includes(normalizedRow)) {
        return true;
    }
    
    return false;
}

// –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (–≤–∏–¥–µ–æ –∏–ª–∏ –±–∞–Ω–Ω–µ—Ä)
function isVideoFormat(format) {
    if (!format) return false;
    const formatLower = format.toLowerCase();
    return formatLower.includes('–≤–∏–¥–µ–æ') || formatLower.includes('video');
}

function renderDashboard() {
    if (!appData) return;

    const campaigns = appData.Total ? appData.Total.data.map(row => row['–ö–∞–º–ø–∞–Ω–∏—è']).filter(Boolean) : [];

    let html = `
        <div class="min-h-screen p-6">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-900">ATL Mediascope —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
                    <div class="text-sm text-gray-500">

                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–ø–∞–Ω–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
    `;

    campaigns.forEach((campaign, idx) => {
        const isSelected = selectedCampaigns.includes(campaign);
        const campaignId = 'campaign_' + idx;
        html += `
            <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 ${isSelected ? 'bg-blue-50 border-blue-500' : 'border-gray-300'}">
                <input type="checkbox" 
                       id="${campaignId}"
                       ${isSelected ? 'checked' : ''} 
                       onchange="toggleCampaignById('${campaignId}')" 
                       class="mr-3">
                <span class="text-sm ${isSelected ? 'font-semibold text-blue-700' : ''}">${campaign}</span>
            </label>
        `;
    });

    html += `
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-sm text-gray-600">
                            –í—ã–±—Ä–∞–Ω–æ: ${selectedCampaigns.length} –∏–∑ ${campaigns.length}
                        </div>
                        <div class="space-x-2">
                            <button onclick="selectAllCampaigns()" class="px-4 py-2 bg-blue-500 text-white rounded text-sm">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                            <button onclick="clearCampaigns()" class="px-4 py-2 bg-gray-500 text-white rounded text-sm">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
    `;

    if (selectedCampaigns.length === 1) {
        const campaign = appData.Total.data.find(row => row['–ö–∞–º–ø–∞–Ω–∏—è'] === selectedCampaigns[0]);
        if (campaign) {
            html += renderSingleCampaign(campaign);
        }
    } else {
        html += renderSummaryTable();
    }

    html += '</div></div>';
    
    document.getElementById('app').innerHTML = html;
    
    if (selectedCampaigns.length === 1 && activeTab === '–ü–ª–æ—â–∞–¥–∫–∏') {
        setTimeout(() => createPlatformChart(), 100);
    }
}

function toggleCampaignById(campaignId) {
    const checkbox = document.getElementById(campaignId);
    if (!checkbox) return;
    
    const label = checkbox.closest('label');
    const campaignName = label.querySelector('span').textContent;
    
    const index = selectedCampaigns.indexOf(campaignName);
    if (index > -1) {
        selectedCampaigns.splice(index, 1);
    } else {
        selectedCampaigns.push(campaignName);
    }
    renderDashboard();
}

function selectAllCampaigns() {
    selectedCampaigns = appData.Total.data.map(row => row['–ö–∞–º–ø–∞–Ω–∏—è']).filter(Boolean);
    renderDashboard();
}

function clearCampaigns() {
    selectedCampaigns = [];
    renderDashboard();
}

function renderSingleCampaign(campaign) {
    const cards = [
        {title: '–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è', value: campaign['–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è'] || '‚Äî', color: 'blue'},
        {title: '–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è', value: campaign['–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è'] || '‚Äî', color: 'green', fullText: true},
        {title: '–ë—é–¥–∂–µ—Ç –∑–∞–º–µ—Ä—è–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫', value: formatNumber(campaign['–ë—é–¥–∂–µ—Ç –∑–∞–º–µ—Ä—è–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫'], 'currency'), color: 'yellow'},
        {title: '% row 18+', value: formatNumber(campaign['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+'], 'percent'), color: 'purple'},
        {title: 'CPM', value: formatNumber(campaign['CPM'], 'cpm'), color: 'pink'},
        {title: 'CPTu –≤ –ª—é–¥—è—Ö', value: formatNumber(campaign['CPTu, –≤ –ª—é–¥—è—Ö'], 'cptu'), color: 'indigo'},
        {title: 'CPTu —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π', value: formatNumber(campaign['CPTu, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π'], 'cptu'), color: 'teal'},
        {title: '–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö', value: formatNumber(campaign['–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'], 'integer'), color: 'orange'},
        {title: '–ü–æ–∫–∞–∑—ã', value: formatNumber(campaign['–ü–æ–∫–∞–∑—ã'], 'integer'), color: 'red'},
        {title: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç', value: formatNumber(campaign['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç'], 'integer'), color: 'gray'},
        {title: '–ß–∞—Å—Ç–æ—Ç–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è', value: formatNumber(campaign['–ß–∞—Å—Ç–æ—Ç–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è'], 'frequency'), color: 'cyan'},
        {title: '–ß–∞—Å—Ç–æ—Ç–∞ –≤ –ª—é–¥—è—Ö', value: formatNumber(campaign['–ß–∞—Å—Ç–æ—Ç–∞, –≤ –ª—é–¥—è—Ö'], 'frequency'), color: 'lime'},
        {title: '% –∑–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫', value: formatNumber(campaign['% –∑–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫'], 'percent_int'), color: 'emerald'}
    ];
    
    let html = `
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-6">${campaign['–ö–∞–º–ø–∞–Ω–∏—è']} ‚Äî –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    `;
    
    cards.forEach(card => {
        html += `
            <div class="bg-${card.color}-50 p-4 rounded">
                <div class="text-sm text-gray-600">${card.title}</div>
                <div class="${card.fullText ? 'text-xs' : 'text-lg'} font-semibold ${card.fullText ? 'leading-tight' : ''}" ${card.fullText ? `title="${card.value}"` : ''}>${card.value}</div>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>

        <div class="bg-white rounded-lg shadow">
            <div class="border-b px-6">
                <nav class="flex space-x-8">
    `;
    
    ['–ì–æ—Ä–æ–¥–∞', '–í–æ–∑—Ä–∞—Å—Ç', '–ü–ª–æ—â–∞–¥–∫–∏', '–ë–µ–∑ –∑–∞–º–µ—Ä–∞'].forEach(tab => {
        const activeClass = activeTab === tab ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500';
        html += `<button onclick="setActiveTab('${tab}')" class="py-4 border-b-2 font-medium text-sm ${activeClass}">${tab}</button>`;
    });
    
    html += `
                </nav>
            </div>
            <div class="p-6">${renderTabContent()}</div>
        </div>
    `;
    
    return html;
}

function renderSummaryTable() {
    const filteredData = selectedCampaigns.length === 0 ? 
        appData.Total.data : 
        appData.Total.data.filter(row => selectedCampaigns.includes(row['–ö–∞–º–ø–∞–Ω–∏—è']));

    const allCPM = filteredData.map(r => r['CPM']);
    const allRowPercent = filteredData.map(r => r['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+']);
    const allCPTu = filteredData.map(r => r['CPTu, –≤ –ª—é–¥—è—Ö']);

    let html = `
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">${selectedCampaigns.length === 0 ? '–í—Å–µ –∫–∞–º–ø–∞–Ω–∏–∏' : `–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ (${selectedCampaigns.length})`}</h2>
                <button onclick="exportSummaryTable()" class="px-4 py-2 bg-green-500 text-white rounded text-sm">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
            <div class="overflow-x-auto max-h-[600px] overflow-y-auto border rounded">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 z-10">
                        <tr class="bg-gray-50" style="height: 50px;">
                            <th class="text-left p-2 border sticky left-0 bg-gray-50 z-20">–ö–∞–º–ø–∞–Ω–∏—è</th>
                            <th class="text-left p-2 border cursor-pointer hover:bg-gray-100" onclick="sortTotalTable('–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è')">
                                –î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è <span class="text-xs">‚ñº‚ñ≤</span>
                            </th>
                            <th class="text-left p-2 border" style="min-width: 350px; max-width: 450px;">–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</th>
                            <th class="text-right p-2 border cursor-pointer hover:bg-gray-100" onclick="sortTotalTable('–ë—é–¥–∂–µ—Ç –∑–∞–º–µ—Ä—è–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫')">
                                –ë—é–¥–∂–µ—Ç –∑–∞–º–µ—Ä—è–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫ <span class="text-xs">‚ñº‚ñ≤</span>
                            </th>
                            <th class="text-right p-2 border" style="height: 50px;">% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+</th>
                            <th class="text-right p-2 border" style="height: 50px;">CPM</th>
                            <th class="text-right p-2 border" style="height: 50px;">CPTu, –≤ –ª—é–¥—è—Ö</th>
                            <th class="text-right p-2 border" style="height: 50px;">CPTu, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π</th>
                            <th class="text-right p-2 border cursor-pointer hover:bg-gray-100" onclick="sortTotalTable('–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö')" style="height: 50px;">
                                –û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö <span class="text-xs">‚ñº‚ñ≤</span>
                            </th>
                            <th class="text-right p-2 border cursor-pointer hover:bg-gray-100" onclick="sortTotalTable('–ü–æ–∫–∞–∑—ã')" style="height: 50px;">
                                –ü–æ–∫–∞–∑—ã <span class="text-xs">‚ñº‚ñ≤</span>
                            </th>
                            <th class="text-right p-2 border" style="height: 50px;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç</th>
                            <th class="text-right p-2 border" style="height: 50px;">–ß–∞—Å—Ç–æ—Ç–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è</th>
                            <th class="text-right p-2 border" style="height: 50px;">–ß–∞—Å—Ç–æ—Ç–∞, –≤ –ª—é–¥—è—Ö</th>
                            <th class="text-right p-2 border" style="height: 50px;">% –∑–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    filteredData.forEach(row => {
        const cpmStyle = getConditionalColor(row['CPM'], allCPM, true);
        const rowPercentStyle = getConditionalColor(row['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+'], allRowPercent, false);
        const cptuStyle = getConditionalColor(row['CPTu, –≤ –ª—é–¥—è—Ö'], allCPTu, true);
        
        html += `
            <tr class="hover:bg-gray-50" style="height: 50px;">
                <td class="p-2 border font-medium sticky left-0 bg-white">${row['–ö–∞–º–ø–∞–Ω–∏—è']}</td>
                <td class="p-2 border whitespace-nowrap">${row['–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è'] || '‚Äî'}</td>
                <td class="p-2 border text-sm" style="min-width: 350px; max-width: 450px;" title="${row['–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è'] || '‚Äî'}">${row['–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è'] || '‚Äî'}</td>
                <td class="text-right p-2 border whitespace-nowrap">${formatNumber(row['–ë—é–¥–∂–µ—Ç –∑–∞–º–µ—Ä—è–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫'], 'currency')}</td>
                <td class="text-right p-2 border whitespace-nowrap" style="${rowPercentStyle}">${formatNumber(row['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+'], 'percent')}</td>
                <td class="text-right p-2 border whitespace-nowrap" style="${cpmStyle}">${formatNumber(row['CPM'], 'cpm')}</td>
                <td class="text-right p-2 border whitespace-nowrap" style="${cptuStyle}">${formatNumber(row['CPTu, –≤ –ª—é–¥—è—Ö'], 'cptu')}</td>
                <td class="text-right p-2 border whitespace-nowrap">${formatNumber(row['CPTu, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π'], 'cptu')}</td>
                <td class="text-right p-2 border whitespace-nowrap">${formatNumber(row['–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'], 'integer')}</td>
                <td class="text-right p-2 border whitespace-nowrap">${formatNumber(row['–ü–æ–∫–∞–∑—ã'], 'integer')}</td>
                <td class="text-right p-2 border whitespace-nowrap">${formatNumber(row['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç'], 'integer')}</td>
                <td class="text-right p-2 border whitespace-nowrap">${formatNumber(row['–ß–∞—Å—Ç–æ—Ç–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è'], 'frequency')}</td>
                <td class="text-right p-2 border whitespace-nowrap">${formatNumber(row['–ß–∞—Å—Ç–æ—Ç–∞, –≤ –ª—é–¥—è—Ö'], 'frequency')}</td>
                <td class="text-right p-2 border whitespace-nowrap">${formatNumber(row['% –∑–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫'], 'percent_int')}</td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    return html;
}

function setActiveTab(tab) {
    activeTab = tab;
    renderDashboard();
}

function renderTabContent() {
    if (!appData || selectedCampaigns.length !== 1) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

    const selectedCampaign = selectedCampaigns[0];
    const sheetName = activeTab === '–ë–µ–∑ –∑–∞–º–µ—Ä–∞' ? '–ü–ª–æ—â–∞–¥–∫–∏' : activeTab;
    const sheetData = appData[sheetName];
    
    if (!sheetData) {
        return `<div class="text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–∏—Å—Ç–∞ "${sheetName}"</div>`;
    }

    const filteredData = sheetData.data.filter(row => {
        const rowCampaign = row['–ö–∞–º–ø–∞–Ω–∏—è'];
        return campaignMatches(rowCampaign, selectedCampaign);
    });

    if (filteredData.length === 0) {
        return `<div class="text-gray-500">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–º–ø–∞–Ω–∏–∏ "${selectedCampaign}"</div>`;
    }

    if (activeTab === '–ì–æ—Ä–æ–¥–∞' || activeTab === '–í–æ–∑—Ä–∞—Å—Ç') {
        return renderCityAgeTab(filteredData);
    } else if (activeTab === '–ü–ª–æ—â–∞–¥–∫–∏') {
        return renderPlatformsTab(filteredData);
    } else if (activeTab === '–ë–µ–∑ –∑–∞–º–µ—Ä–∞') {
        return renderNoMeasurementTab(filteredData);
    }
    
    return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
}

function renderCityAgeTab(filteredData) {
    const exportType = activeTab === '–ì–æ—Ä–æ–¥–∞' ? 'cities' : 'age';
    
    const standardAgeGroups = ['12-17', '18-24', '25-34', '35-44', '45-54', '55-64', '65+'];
    
    const dataForFormatting = activeTab === '–ì–æ—Ä–æ–¥–∞' ? 
        filteredData : 
        filteredData.filter(r => standardAgeGroups.includes(r['–ì—Ä—É–ø–ø–∞']));
    
    const allReachCol = dataForFormatting.map(r => r['Reach col%']);
    const allReachRow = dataForFormatting.map(r => r['Reach row%']);
    
    let html = `
        <div class="mb-4">
            <button onclick="exportTable('${exportType}')" class="px-4 py-2 bg-green-500 text-white rounded text-sm mr-2">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>
        
        <!-- LAYOUT: –¢–ê–ë–õ–ò–¶–ê –°–õ–ï–í–ê + –î–ò–ê–ì–†–ê–ú–ú–ê –°–ü–†–ê–í–ê -->
        <div class="flex gap-6">
            <!-- –¢–ê–ë–õ–ò–¶–ê -->
            <div class="flex-1 overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-left p-2 border" style="height: 40px;">–ì—Ä—É–ø–ø–∞</th>
                            <th class="text-right p-2 border" style="height: 40px;">OTS</th>
                            <th class="text-right p-2 border" style="height: 40px;">OTS col%</th>
                            <th class="text-right p-2 border" style="height: 40px;">OTS row%</th>
                            <th class="text-right p-2 border" style="height: 40px;">Reach</th>
                            <th class="text-right p-2 border" style="height: 40px;">Frequency</th>
                            <th class="text-right p-2 border" style="height: 40px;">Reach col%</th>
                            <th class="text-right p-2 border" style="height: 40px;">Reach row%</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    filteredData.forEach(row => {
        const isTargetAudience = activeTab === '–í–æ–∑—Ä–∞—Å—Ç' && !standardAgeGroups.includes(row['–ì—Ä—É–ø–ø–∞']);
        
        const reachColStyle = isTargetAudience ? '' : getConditionalColor(row['Reach col%'], allReachCol, false);
        const reachRowStyle = isTargetAudience ? '' : getConditionalColor(row['Reach row%'], allReachRow, false);
        
        html += `
            <tr class="hover:bg-gray-50" style="height: 40px;">
                <td class="p-2 border font-medium">${row['–ì—Ä—É–ø–ø–∞'] || '‚Äî'}</td>
                <td class="text-right p-2 border">${formatNumber(row['OTS'], 'integer')}</td>
                <td class="text-right p-2 border">${formatNumber(row['OTS col%'], 'percent_int')}</td>
                <td class="text-right p-2 border">${formatNumber(row['OTS row%'], 'percent4')}</td>
                <td class="text-right p-2 border">${formatNumber(row['Reach'], 'integer')}</td>
                <td class="text-right p-2 border">${formatNumber(row['Frequency'], 'frequency')}</td>
                <td class="text-right p-2 border" style="${reachColStyle}">${formatNumber(row['Reach col%'], 'percent_int')}</td>
                <td class="text-right p-2 border" style="${reachRowStyle}">${formatNumber(row['Reach row%'], 'percent')}</td>
            </tr>
        `;
    });
    
    html += `
                    </tbody>
                </table>
            </div>
            
            <!-- –ö–†–£–ì–û–í–ê–Ø –î–ò–ê–ì–†–ê–ú–ú–ê –°–ü–†–ê–í–ê -->
            <div class="flex-shrink-0" style="width: 350px;">
                <div class="bg-white rounded-lg shadow p-4 sticky top-4">
                    <h3 class="text-sm font-semibold mb-3 text-center">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ö–≤–∞—Ç–∞<br>(Reach col%)</h3>
                    <div class="flex justify-center">
                        <canvas id="pieChart" width="300" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // –°–æ–∑–¥–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ HTML
    setTimeout(() => createPieChart(dataForFormatting), 100);
    
    return html;
}

function renderPlatformsTab(filteredData) {
    const platformsWithMeasurement = filteredData.filter(row => {
        if (row['–ü–ª–æ—â–∞–¥–∫–∞'] === 'Total') return false;
        const mediascopeReach = row['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)'];
        const numericReach = parseFloat(mediascopeReach);
        return !isNaN(numericReach) && mediascopeReach !== null && mediascopeReach !== '' && mediascopeReach !== undefined;
    }).sort((a, b) => {
        const reachA = parseFloat(a['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)']) || 0;
        const reachB = parseFloat(b['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)']) || 0;
        return reachB - reachA;  // –°–û–†–¢–ò–†–û–í–ö–ê –ü–û –£–ë–´–í–ê–ù–ò–Æ –û–•–í–ê–¢–ê
    });

    const allCPM = platformsWithMeasurement.map(r => r['CPM']);
    const allBudgetPercent = platformsWithMeasurement.map(r => r['% –±—é–¥–∂–µ—Ç']);
    const allShowPercent = platformsWithMeasurement.map(r => r['% –ü–æ–∫–∞–∑—ã']);
    const allColPercent = platformsWithMeasurement.map(r => r['% col, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö']);
    const allRowPercent = platformsWithMeasurement.map(r => r['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+']);
    const allCPTu = platformsWithMeasurement.map(r => r['CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö']);
            
    let html = `
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4">–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö –∏ CPTu –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º</h3>
            <div class="bg-gray-50 p-4 rounded-lg">
                <canvas id="platformChart" width="1500" height="500"></canvas>
            </div>
        </div>
        <div class="mb-4">
            <button onclick="exportTable('platforms')" class="px-4 py-2 bg-green-500 text-white rounded text-sm mr-2">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="text-left p-3 border">–ü–ª–æ—â–∞–¥–∫–∞</th>
                        <th class="text-left p-3 border">–§–æ—Ä–º–∞—Ç—ã</th>
                        <th class="text-right p-3 border">–ë—é–¥–∂–µ—Ç</th>
                        <th class="text-right p-3 border">% –±—é–¥–∂–µ—Ç</th>
                        <th class="text-right p-3 border">CPM</th>
                        <th class="text-right p-3 border">–ü–æ–∫–∞–∑—ã</th>
                        <th class="text-right p-3 border">% –ü–æ–∫–∞–∑—ã</th>
                        <th class="text-right p-3 border">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç</th>
                        <th class="text-right p-3 border">–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)</th>
                        <th class="text-right p-3 border">% col, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö</th>
                        <th class="text-right p-3 border">% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+</th>
                        <th class="text-right p-3 border">CPTu, —Ç–µ—Ö. –æ—Ö–≤–∞—Ç</th>
                        <th class="text-right p-3 border">CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö</th>
                        <th class="text-right p-3 border">–ß–∞—Å—Ç–æ—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ –ª—é–¥—è—Ö</th>
                        <th class="text-right p-3 border">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–∫ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞</th>
                        <th class="text-right p-3 border">–†–∞–∑–Ω–∏—Ü–∞ —Ç–µ—Ö. –æ—Ö–≤–∞—Ç vs –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    platformsWithMeasurement.forEach(row => {
        const cpmStyle = getConditionalColor(row['CPM'], allCPM, true);
        const budgetPercentStyle = getConditionalColor(row['% –±—é–¥–∂–µ—Ç'], allBudgetPercent, false);
        const showPercentStyle = getConditionalColor(row['% –ü–æ–∫–∞–∑—ã'], allShowPercent, false);
        const colPercentStyle = getConditionalColor(row['% col, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'], allColPercent, false);
        const rowPercentStyle = getConditionalColor(row['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+'], allRowPercent, false);
        const cptuStyle = getConditionalColor(row['CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'], allCPTu, true);
        
        // –†–ê–°–¶–í–ï–¢–ö–ê –°–¢–†–û–ö –ü–û –¢–ò–ü–£ –§–û–†–ú–ê–¢–ê
        const isVideo = isVideoFormat(row['–§–æ—Ä–º–∞—Ç—ã']);
        const rowBgColor = isVideo ? 'rgba(96, 165, 250, 0.15)' : 'rgba(134, 239, 172, 0.15)';
        
        html += `
            <tr class="hover:opacity-90" style="background-color: ${rowBgColor};">
                <td class="p-3 border font-medium whitespace-nowrap">${row['–ü–ª–æ—â–∞–¥–∫–∞'] || '‚Äî'}</td>
                <td class="p-3 border text-xs">${row['–§–æ—Ä–º–∞—Ç—ã'] || '‚Äî'}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–ë—é–¥–∂–µ—Ç'], 'currency')}</td>
                <td class="text-right p-3 border whitespace-nowrap" style="${budgetPercentStyle}">${formatNumber(row['% –±—é–¥–∂–µ—Ç'], 'percent_int')}</td>
                <td class="text-right p-3 border whitespace-nowrap" style="${cpmStyle}">${formatNumber(row['CPM'], 'cpm')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–ü–æ–∫–∞–∑—ã'], 'integer')}</td>
                <td class="text-right p-3 border whitespace-nowrap" style="${showPercentStyle}">${formatNumber(row['% –ü–æ–∫–∞–∑—ã'], 'percent_int')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç'], 'integer')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)'], 'integer')}</td>
                <td class="text-right p-3 border whitespace-nowrap" style="${colPercentStyle}">${formatNumber(row['% col, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'], 'percent_int')}</td>
                <td class="text-right p-3 border whitespace-nowrap" style="${rowPercentStyle}">${formatNumber(row['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+'], 'percent')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['CPTu, —Ç–µ—Ö. –æ—Ö–≤–∞—Ç'], 'cptu')}</td>
                <td class="text-right p-3 border whitespace-nowrap" style="${cptuStyle}">${formatNumber(row['CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'], 'cptu')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–ß–∞—Å—Ç–æ—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ –ª—é–¥—è—Ö'], 'frequency')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–∫ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞'], 'frequency')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–†–∞–∑–Ω–∏—Ü–∞ —Ç–µ—Ö. –æ—Ö–≤–∞—Ç vs –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'], 'percent')}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    return html;
}

function renderNoMeasurementTab(filteredData) {
    const platformsWithoutMeasurement = filteredData.filter(row => {
        if (row['–ü–ª–æ—â–∞–¥–∫–∞'] === 'Total') return false;
        const mediascopeReach = row['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)'];
        const numericReach = parseFloat(mediascopeReach);
        return isNaN(numericReach) || mediascopeReach === null || mediascopeReach === '' || mediascopeReach === undefined;
    }).sort((a, b) => {
        const budgetA = parseFloat(a['–ë—é–¥–∂–µ—Ç']) || 0;
        const budgetB = parseFloat(b['–ë—é–¥–∂–µ—Ç']) || 0;
        return budgetB - budgetA;
    });

    if (platformsWithoutMeasurement.length === 0) {
        return '<div class="text-gray-500">–í—Å–µ –ø–ª–æ—â–∞–¥–∫–∏ –∏–º–µ—é—Ç –∑–∞–º–µ—Ä</div>';
    }

    let html = `
        <div class="mb-4">
            <button onclick="exportTable('no_measurement')" class="px-4 py-2 bg-green-500 text-white rounded text-sm mr-2">üìä –≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="text-left p-3 border">–ü–ª–æ—â–∞–¥–∫–∞</th>
                        <th class="text-left p-3 border">–§–æ—Ä–º–∞—Ç—ã</th>
                        <th class="text-right p-3 border">–ë—é–¥–∂–µ—Ç</th>
                        <th class="text-right p-3 border">% –±—é–¥–∂–µ—Ç</th>
                        <th class="text-right p-3 border">CPM</th>
                        <th class="text-right p-3 border">–ü–æ–∫–∞–∑—ã</th>
                        <th class="text-right p-3 border">% –ü–æ–∫–∞–∑—ã</th>
                        <th class="text-right p-3 border">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç</th>
                        <th class="text-right p-3 border">CPTu, —Ç–µ—Ö. –æ—Ö–≤–∞—Ç</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    platformsWithoutMeasurement.forEach(row => {
        html += `
            <tr class="hover:bg-gray-50">
                <td class="p-3 border font-medium whitespace-nowrap">${row['–ü–ª–æ—â–∞–¥–∫–∞'] || '‚Äî'}</td>
                <td class="p-3 border text-xs">${row['–§–æ—Ä–º–∞—Ç—ã'] || '‚Äî'}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–ë—é–¥–∂–µ—Ç'], 'currency')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['% –±—é–¥–∂–µ—Ç'], 'percent_int')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['CPM'], 'cpm')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–ü–æ–∫–∞–∑—ã'], 'integer')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['% –ü–æ–∫–∞–∑—ã'], 'percent_int')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç'], 'integer')}</td>
                <td class="text-right p-3 border whitespace-nowrap">${formatNumber(row['CPTu, —Ç–µ—Ö. –æ—Ö–≤–∞—Ç'], 'cptu')}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    return html;
}

// –ì–†–ê–§–ò–ö –° –°–û–†–¢–ò–†–û–í–ö–û–ô –ü–û –£–ë–´–í–ê–ù–ò–Æ –ò CPTu –¢–û–õ–¨–ö–û –¢–û–ß–ö–ê–ú–ò
function createPlatformChart() {
    const selectedCampaign = selectedCampaigns[0];
    const sheetData = appData['–ü–ª–æ—â–∞–¥–∫–∏'];
    
    if (!sheetData) return;

    const filteredData = sheetData.data.filter(row => {
        const rowCampaign = row['–ö–∞–º–ø–∞–Ω–∏—è'];
        if (!rowCampaign) return false;
        if (row['–ü–ª–æ—â–∞–¥–∫–∞'] === 'Total') return false;
        const mediascopeReach = row['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)'];
        const numericReach = parseFloat(mediascopeReach);
        return campaignMatches(rowCampaign, selectedCampaign) &&
               !isNaN(numericReach) && mediascopeReach !== null && mediascopeReach !== '';
    }).sort((a, b) => {
        // –°–û–†–¢–ò–†–û–í–ö–ê –ü–û –£–ë–´–í–ê–ù–ò–Æ –û–•–í–ê–¢–ê –í –õ–Æ–î–Ø–•
        const reachA = parseFloat(a['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)']) || 0;
        const reachB = parseFloat(b['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)']) || 0;
        return reachB - reachA;
    }).slice(0, 15);

    const canvas = document.getElementById('platformChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    
    if (window.platformChart instanceof Chart) {
        window.platformChart.destroy();
    }

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç–æ–ª–±—Ü–æ–≤ –ø–æ —Ç–∏–ø—É —Ñ–æ—Ä–º–∞—Ç–∞
    const barColors = filteredData.map(row => {
        const format = row['–§–æ—Ä–º–∞—Ç—ã'] || '';
        if (isVideoFormat(format)) {
            return 'rgba(96, 165, 250, 0.7)'; // –°–∏–Ω–∏–π –¥–ª—è –≤–∏–¥–µ–æ
        } else {
            return 'rgba(134, 239, 172, 0.7)'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –±–∞–Ω–Ω–µ—Ä–æ–≤
        }
    });

    window.platformChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: filteredData.map(row => row['–ü–ª–æ—â–∞–¥–∫–∞']),
            datasets: [
                {
                    type: 'bar',
                    label: '–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö (Mediascope)',
                    data: filteredData.map(row => parseFloat(row['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)']) || 0),
                    backgroundColor: barColors,
                    borderColor: barColors.map(color => color.replace('0.7', '1')),
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: 'CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö (‚ÇΩ)',
                    data: filteredData.map(row => parseFloat(row['CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö']) || 0),
                    borderColor: 'rgba(0, 0, 0, 0)',  // –ü–†–û–ó–†–ê–ß–ù–ê–Ø –õ–ò–ù–ò–Ø
                    backgroundColor: 'rgba(239, 68, 68, 0)',
                    borderWidth: 0,  // –ë–ï–ó –õ–ò–ù–ò–ò
                    pointRadius: 6,  // –¢–û–õ–¨–ö–û –¢–û–ß–ö–ò
                    pointBackgroundColor: 'rgb(239, 68, 68)',
                    pointBorderColor: 'rgb(239, 68, 68)',
                    pointBorderWidth: 2,
                    yAxisID: 'y1',
                    showLine: false  // –û–¢–ö–õ–Æ–ß–ê–ï–ú –õ–ò–ù–ò–Æ
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        generateLabels: function(chart) {
                            return [
                                {
                                    text: '–í–∏–¥–µ–æ —Ñ–æ—Ä–º–∞—Ç—ã',
                                    fillStyle: 'rgba(96, 165, 250, 0.7)',
                                    strokeStyle: 'rgba(96, 165, 250, 1)',
                                    lineWidth: 1
                                },
                                {
                                    text: '–ë–∞–Ω–Ω–µ—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã',
                                    fillStyle: 'rgba(134, 239, 172, 0.7)',
                                    strokeStyle: 'rgba(134, 239, 172, 1)',
                                    lineWidth: 1
                                },
                                {
                                    text: 'CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö (‚ÇΩ)',
                                    fillStyle: 'rgb(239, 68, 68)',
                                    strokeStyle: 'rgb(239, 68, 68)',
                                    lineWidth: 0,
                                    pointStyle: 'circle'
                                }
                            ];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += context.parsed.y.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                                } else {
                                    label += context.parsed.y.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚ÇΩ';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ru-RU');
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'CPTu (‚ÇΩ)'
                    },
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚ÇΩ';
                        }
                    }
                }
            }
        }
    });
}

// –§–£–ù–ö–¶–ò–Ø –°–û–ó–î–ê–ù–ò–Ø –ö–†–£–ì–û–í–û–ô –î–ò–ê–ì–†–ê–ú–ú–´ –î–õ–Ø –í–û–ó–†–ê–°–¢–ê –ò –ì–û–†–û–î–û–í
function createPieChart(data) {
    const canvas = document.getElementById('pieChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    
    // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if (window.pieChart instanceof Chart) {
        window.pieChart.destroy();
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
    const labels = data.map(row => row['–ì—Ä—É–ø–ø–∞']);
    
    // –ü–†–ê–í–ò–õ–¨–ù–û–ï –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ü–†–û–¶–ï–ù–¢–û–í
    const values = data.map(row => {
        let val = row['Reach col%'];
        
        // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ null/undefined/–ø—É—Å—Ç–æ–µ
        if (val === null || val === undefined || val === '') {
            return 0;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å %
        if (typeof val === 'string') {
            val = val.replace('%', '').replace(',', '.').trim();
            const numVal = parseFloat(val);
            return isNaN(numVal) ? 0 : numVal;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ (–≤–µ—Ä–æ—è—Ç–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 0.08 –¥–ª—è 8%)
        const numVal = parseFloat(val);
        if (isNaN(numVal)) return 0;
        
        // –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 1, —ç—Ç–æ –¥–µ—Å—è—Ç–∏—á–Ω–∞—è –¥—Ä–æ–±—å - —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ 100
        if (numVal < 1) {
            return numVal * 100;
        }
        
        return numVal;
    });
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
    const colors = generatePieColors(data.length);

    window.pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors.background,
                borderColor: colors.border,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 11
                        },
                        padding: 8,
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    return {
                                        text: `${label}: ${value.toFixed(0)}%`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        strokeStyle: data.datasets[0].borderColor[i],
                                        lineWidth: 2,
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            return `${label}: ${value.toFixed(0)}%`;
                        }
                    }
                }
            }
        }
    });
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
function generatePieColors(count) {
    const colorPalette = [
        'rgba(59, 130, 246, 0.8)',   // –°–∏–Ω–∏–π
        'rgba(16, 185, 129, 0.8)',   // –ó–µ–ª–µ–Ω—ã–π
        'rgba(251, 146, 60, 0.8)',   // –û—Ä–∞–Ω–∂–µ–≤—ã–π
        'rgba(239, 68, 68, 0.8)',    // –ö—Ä–∞—Å–Ω—ã–π
        'rgba(168, 85, 247, 0.8)',   // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        'rgba(236, 72, 153, 0.8)',   // –†–æ–∑–æ–≤—ã–π
        'rgba(245, 158, 11, 0.8)',   // –Ø–Ω—Ç–∞—Ä–Ω—ã–π
        'rgba(14, 165, 233, 0.8)',   // –ì–æ–ª—É–±–æ–π
        'rgba(139, 92, 246, 0.8)',   // –ò–Ω–¥–∏–≥–æ
        'rgba(34, 197, 94, 0.8)',    // –õ–∞–π–º
        'rgba(234, 179, 8, 0.8)',    // –ñ–µ–ª—Ç—ã–π
        'rgba(20, 184, 166, 0.8)',   // –ë–∏—Ä—é–∑–æ–≤—ã–π
    ];
    
    const background = [];
    const border = [];
    
    for (let i = 0; i < count; i++) {
        const color = colorPalette[i % colorPalette.length];
        background.push(color);
        border.push(color.replace('0.8', '1'));
    }
    
    return { background, border };
}

function exportTable(tableType) {
    if (!appData || selectedCampaigns.length !== 1) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∫–∞–º–ø–∞–Ω–∏—é –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const selectedCampaign = selectedCampaigns[0];
    let exportData = [];
    let fileName = '';

    if (tableType === 'platforms') {
        const sheetData = appData['–ü–ª–æ—â–∞–¥–∫–∏'];
        if (!sheetData) return;

        const filteredData = sheetData.data.filter(row => {
            const rowCampaign = row['–ö–∞–º–ø–∞–Ω–∏—è'];
            if (!rowCampaign) return false;
            if (row['–ü–ª–æ—â–∞–¥–∫–∞'] === 'Total') return false;
            const mediascopeReach = row['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)'];
            const numericReach = parseFloat(mediascopeReach);
            return campaignMatches(rowCampaign, selectedCampaign) &&
                   !isNaN(numericReach) && mediascopeReach !== null && mediascopeReach !== '';
        });

        exportData = filteredData.map(row => ({
            '–ü–ª–æ—â–∞–¥–∫–∞': row['–ü–ª–æ—â–∞–¥–∫–∞'],
            '–§–æ—Ä–º–∞—Ç—ã': row['–§–æ—Ä–º–∞—Ç—ã'],
            '–ë—é–¥–∂–µ—Ç': row['–ë—é–¥–∂–µ—Ç'],
            '% –±—é–¥–∂–µ—Ç': row['% –±—é–¥–∂–µ—Ç'],
            'CPM': row['CPM'],
            '–ü–æ–∫–∞–∑—ã': row['–ü–æ–∫–∞–∑—ã'],
            '% –ü–æ–∫–∞–∑—ã': row['% –ü–æ–∫–∞–∑—ã'],
            '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç': row['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç'],
            '–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö (Mediascope)': row['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)'],
            '% col, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö': row['% col, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'],
            '% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+': row['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+'],
            'CPTu, —Ç–µ—Ö. –æ—Ö–≤–∞—Ç': row['CPTu, —Ç–µ—Ö. –æ—Ö–≤–∞—Ç'],
            'CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö': row['CPTu, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'],
            '–ß–∞—Å—Ç–æ—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ –ª—é–¥—è—Ö': row['–ß–∞—Å—Ç–æ—Ç–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ –ª—é–¥—è—Ö'],
            '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–∫ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞': row['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–∫ –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞'],
            '–†–∞–∑–Ω–∏—Ü–∞ —Ç–µ—Ö. –æ—Ö–≤–∞—Ç vs –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö': row['–†–∞–∑–Ω–∏—Ü–∞ —Ç–µ—Ö. –æ—Ö–≤–∞—Ç vs –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö']
        }));
        fileName = selectedCampaign + '_–ü–ª–æ—â–∞–¥–∫–∏.xlsx';

    } else if (tableType === 'no_measurement') {
        const sheetData = appData['–ü–ª–æ—â–∞–¥–∫–∏'];
        if (!sheetData) return;

        const filteredData = sheetData.data.filter(row => {
            const rowCampaign = row['–ö–∞–º–ø–∞–Ω–∏—è'];
            if (!rowCampaign) return false;
            if (row['–ü–ª–æ—â–∞–¥–∫–∞'] === 'Total') return false;
            const mediascopeReach = row['–û—Ö–≤–∞—Ç—ã –≤ –ª—é–¥—è—Ö (Mediascope)'];
            const numericReach = parseFloat(mediascopeReach);
            return campaignMatches(rowCampaign, selectedCampaign) &&
                   (isNaN(numericReach) || mediascopeReach === null || mediascopeReach === '');
        });

        exportData = filteredData.map(row => ({
            '–ü–ª–æ—â–∞–¥–∫–∞': row['–ü–ª–æ—â–∞–¥–∫–∞'],
            '–§–æ—Ä–º–∞—Ç—ã': row['–§–æ—Ä–º–∞—Ç—ã'],
            '–ë—é–¥–∂–µ—Ç': row['–ë—é–¥–∂–µ—Ç'],
            '% –±—é–¥–∂–µ—Ç': row['% –±—é–¥–∂–µ—Ç'],
            'CPM': row['CPM'],
            '–ü–æ–∫–∞–∑—ã': row['–ü–æ–∫–∞–∑—ã'],
            '% –ü–æ–∫–∞–∑—ã': row['% –ü–æ–∫–∞–∑—ã'],
            '–¢–µ—Ö. –æ—Ö–≤–∞—Ç': row['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç'],
            'CPTu —Ç–µ—Ö.': row['CPTu, —Ç–µ—Ö. –æ—Ö–≤–∞—Ç']
        }));
        fileName = selectedCampaign + '_–ü–ª–æ—â–∞–¥–∫–∏_–±–µ–∑_–∑–∞–º–µ—Ä–∞.xlsx';

    } else if (tableType === 'cities') {
        const sheetData = appData['–ì–æ—Ä–æ–¥–∞'];
        if (!sheetData) return;

        const filteredData = sheetData.data.filter(row => {
            const rowCampaign = row['–ö–∞–º–ø–∞–Ω–∏—è'];
            return campaignMatches(rowCampaign, selectedCampaign);
        });

        exportData = filteredData.map(row => ({
            '–ì—Ä—É–ø–ø–∞': row['–ì—Ä—É–ø–ø–∞'],
            'OTS': row['OTS'],
            'OTS col%': row['OTS col%'],
            'OTS row%': row['OTS row%'],
            'Reach': row['Reach'],
            'Frequency': row['Frequency'],
            'Reach col%': row['Reach col%'],
            'Reach row%': row['Reach row%']
        }));
        fileName = selectedCampaign + '_–ì–æ—Ä–æ–¥–∞.xlsx';

    } else if (tableType === 'age') {
        const sheetData = appData['–í–æ–∑—Ä–∞—Å—Ç'];
        if (!sheetData) return;

        const filteredData = sheetData.data.filter(row => {
            const rowCampaign = row['–ö–∞–º–ø–∞–Ω–∏—è'];
            return campaignMatches(rowCampaign, selectedCampaign);
        });

        exportData = filteredData.map(row => ({
            '–ì—Ä—É–ø–ø–∞': row['–ì—Ä—É–ø–ø–∞'],
            'OTS': row['OTS'],
            'OTS col%': row['OTS col%'],
            'OTS row%': row['OTS row%'],
            'Reach': row['Reach'],
            'Frequency': row['Frequency'],
            'Reach col%': row['Reach col%'],
            'Reach row%': row['Reach row%']
        }));
        fileName = selectedCampaign + '_–í–æ–∑—Ä–∞—Å—Ç.xlsx';
    }

    if (exportData.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–î–∞–Ω–Ω—ã–µ');
    XLSX.writeFile(wb, fileName);
}

function exportSummaryTable() {
    if (!appData || !appData.Total) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const filteredData = selectedCampaigns.length === 0 ? 
        appData.Total.data : 
        appData.Total.data.filter(row => selectedCampaigns.includes(row['–ö–∞–º–ø–∞–Ω–∏—è']));

    const exportData = filteredData.map(row => ({
        '–ö–∞–º–ø–∞–Ω–∏—è': row['–ö–∞–º–ø–∞–Ω–∏—è'],
        '–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è': row['–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è'] || '',
        '–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è': row['–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è'] || '',
        '–ë—é–¥–∂–µ—Ç –∑–∞–º–µ—Ä—è–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫': row['–ë—é–¥–∂–µ—Ç –∑–∞–º–µ—Ä—è–µ–º—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫'],
        '% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+': row['% row, –æ—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö 18+'],
        'CPM': row['CPM'],
        'CPTu, –≤ –ª—é–¥—è—Ö': row['CPTu, –≤ –ª—é–¥—è—Ö'],
        'CPTu, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π': row['CPTu, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π'],
        '–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö': row['–û—Ö–≤–∞—Ç –≤ –ª—é–¥—è—Ö'],
        '–ü–æ–∫–∞–∑—ã': row['–ü–æ–∫–∞–∑—ã'],
        '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç': row['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç'],
        '–ß–∞—Å—Ç–æ—Ç–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è': row['–ß–∞—Å—Ç–æ—Ç–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è'],
        '–ß–∞—Å—Ç–æ—Ç–∞, –≤ –ª—é–¥—è—Ö': row['–ß–∞—Å—Ç–æ—Ç–∞, –≤ –ª—é–¥—è—Ö'],
        '% –∑–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫': row['% –∑–∞–º–µ—Ä–µ–Ω–Ω—ã—Ö –ø–ª–æ—â–∞–¥–æ–∫']
    }));

    if (exportData.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const fileName = selectedCampaigns.length === 0 ? 
        '–í—Å–µ_–∫–∞–º–ø–∞–Ω–∏–∏_—Å–≤–æ–¥–Ω–∞—è.xlsx' : 
        '–í—ã–±—Ä–∞–Ω–Ω—ã–µ_–∫–∞–º–ø–∞–Ω–∏–∏_—Å–≤–æ–¥–Ω–∞—è.xlsx';

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞');
    XLSX.writeFile(wb, fileName);
}

let totalTableSortState = {};

function sortTotalTable(column) {
    if (!appData || !appData.Total) return;
    
    if (!totalTableSortState[column]) {
        totalTableSortState[column] = 'desc';
    } else if (totalTableSortState[column] === 'desc') {
        totalTableSortState[column] = 'asc';
    } else {
        totalTableSortState[column] = 'desc';
    }
    
    const direction = totalTableSortState[column];
    
    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –¥–∞—Ç
    if (column === '–î–∞—Ç—ã –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è') {
        appData.Total.data.sort((a, b) => {
            const parseDateRange = (dateStr) => {
                if (!dateStr) return { start: null, end: null };
                
                const parts = dateStr.split('-').map(s => s.trim());
                
                if (parts.length === 2) {
                    const parseDate = (d) => {
                        const [day, month, year] = d.split('.').map(Number);
                        return new Date(year, month - 1, day);
                    };
                    
                    return {
                        start: parseDate(parts[0]),
                        end: parseDate(parts[1])
                    };
                }
                
                return { start: null, end: null };
            };
            
            const datesA = parseDateRange(a[column]);
            const datesB = parseDateRange(b[column]);
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è, –∑–∞—Ç–µ–º –ø–æ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞
            if (datesA.end && datesB.end) {
                if (direction === 'desc') {
                    // –û—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º
                    if (datesA.end > datesB.end) return -1;
                    if (datesA.end < datesB.end) return 1;
                    
                    if (datesA.start && datesB.start) {
                        if (datesA.start > datesB.start) return -1;
                        if (datesA.start < datesB.start) return 1;
                    }
                } else {
                    // –û—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º
                    if (datesA.end < datesB.end) return -1;
                    if (datesA.end > datesB.end) return 1;
                    
                    if (datesA.start && datesB.start) {
                        if (datesA.start < datesB.start) return -1;
                        if (datesA.start > datesB.start) return 1;
                    }
                }
            }
            
            // –ö–∞–º–ø–∞–Ω–∏–∏ –±–µ–∑ –¥–∞—Ç –≤ –∫–æ–Ω–µ—Ü
            if (datesA.end && !datesB.end) return -1;
            if (!datesA.end && datesB.end) return 1;
            
            return 0;
        });
    } else {
        // –û–±—ã—á–Ω–∞—è —á–∏—Å–ª–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        appData.Total.data.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            
            if (typeof valA === 'string') valA = parseFloat(valA) || 0;
            if (typeof valB === 'string') valB = parseFloat(valB) || 0;
            
            if (direction === 'desc') {
                return valB - valA;
            } else {
                return valA - valB;
            }
        });
    }
    
    renderDashboard();
}
    </script>
</body>
</html>

